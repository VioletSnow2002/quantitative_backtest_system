## 回测策略
我们考虑回测一类**动量**和**反转**策略, 以反转策略为例, 具体定义如下:

给定排序时长 $n$. 在每个交易日结束前, 计算 (一定范围内) 所有股票在前 $n$ 个交易日 (含当天) 的累计收益率. 根据该收益率得到当天的目标股票集 $\mathcal{S}$, 并将现有资金重新等额分配在 $\mathcal{S}$ 中各只股票上:
- 对于反转策略, 取收益率最低的 $10\%$ (也可以换成任意其他给定的比例, 或股票数量).
- 对于动量策略, 取收益率最高的 $10\%$.

## 回测指标
### 净值曲线
在整个持有期, 我们在每天结束时计算当前股票组合的总价值相对期初价值的倍数. 具体而言, 第 $j$ 天末的的净值 $V_j$ 由下式给出:
$$\begin{equation}V_j=V_{j-1}\cdot(1+|\mathcal{S}_j|^{-1}\sum_{s\in \mathcal{S}_j}R_j(s)),\ V_0=1.\end{equation}$$
其中 $R_j(s)$ 表示股票 $s$ 在第 $j$ 天的日收益率.
### 超额收益
我们将投资组合的净值曲线与 A 股指数对比计算超额收益. 指数 $I_j$ 的计算方式与 $(1)$ 式相同, 唯一的区别在于此时的 $\mathcal{S}_j$ 为当天的所有股票 (可能会排除一些刚刚上市的新股).
### 年化收益
设持有期为 $N$ 天, 年化收益率由下式给出:
$$r=(\frac{V_N}{V_0})^{N_{year}/N}-1,$$
其中 $N_{year}=252$ 为一年的交易日数量.
### 年化波动
年化波动率由下式给出:
$$\sigma=\sqrt{\frac{N_{year}}{N-1}\sum_{j=1}^N(r_j-\bar{r})^2},$$
其中 $r_j$ 为投资组合的简单收益率 $V_j/V_{j-1}-1$ 或对数收益率 $\log(V_j/V_{j-1})$.
### 夏普比率
夏普比率由下式给出:
$$S=\frac{r-r_f}{\sigma},$$
其中 $r_f$ 为无风险利率.
### 最大回撤
最大回撤 $D=max_{i<j}\{(V_i-V_j)/V_i\}\cdot100\%$.
### 收益分解
根据 **CAPM 模型**, 我们计算投资组合的 $\beta$ 与 $\alpha$ 值.
$$\beta=\frac{\sum(r_j-\bar{r})(r_{m,j}-\bar{r}_m)}{\sum(r_{m,j}-\bar{r}_m)^2},$$
$$\alpha=r-(r_f+\beta(r_m-r_f)).$$
其中 $r_{m,j}$ 为第 $j$ 天的市场简单收益率或对数收益率, $r_m$ 为市场年化收益率, $r_f$ 为无风险利率.

## 代码功能模块分解
### 数据读取
使用 `load.py` 模块进行股票数据的读取.

该模块预期包括下列函数. 这里仅展示直接供用户使用的顶层函数, 用于实现这些函数的下层函数不予展示. 目前预计实现的策略中并不会用到基本面数据, 但这里仍然为用户提供查看这些数据的接口.
- `single_daily()`: 根据股票代码, 起始日期, 终止日期, 是否复权 4 个参数返回某只股票在特定时间段内的日行情. 若不指定股票代码, 则返回所有股票的行情, 下同.
- `balance()`: 根据股票代码, 起始日期, 终止日期 3 个参数返回某只股票在特定时间段内的资产负债表. 列名已使用 `stk_fin_item_map.feather` 数据集进行还原, 下同.
- `income()`: 根据股票代码, 起始日期, 终止日期 3 个参数返回某只股票在特定时间段内的利润表.
- `cashflow()`: 根据股票代码, 起始日期, 终止日期 3 个参数返回某只股票在特定时间段内的现金流量表.
- `annotation()`: 根据股票代码, 起始日期, 终止日期 3 个参数返回某只股票在特定时间段内的财务报表附注.
- `close_daily()`: 返回所有股票在特定时间段内经复权的收盘价, 用于信号的生成.
- `index_daily()`: 返回特定时间段内的 A 股指数日行情. 该指数通过 `stk_daily.feather` 数据计算得到.
### 生成信号
使用 `signalgen.py` 模块进行生成交易信号. 具体来说, 我们给出实施反转 (动量) 策略时, 每个交易日结束后需要持有的股票.
1. 使用 `signal(start_date, end_date, period, )` 函数, 计算给定时间段中各股票每天的前 $n=$`period` 日累计收益率.
2. 在累计收益率的基础上, 使用 `stocks(strat_date, end_date, p=0.1, rever=True, )` 函数, 在给定时间段的每个交易日中得到前 $n$ 日收益率最低 (动量策略中为最高) 的一定比例的股票 $\mathcal{S}_{j}$. 上述比例由 `p` 给出, `rever` 参数表示是否使用反转策略.
### 回测实现
使用 `backtest.py` 模块对策略进行回测. 

- `value(start_date, end_date, p=0.1, rever=True, )` 函数根据 `stocks()` 生成的 $\mathcal{S}_j$ 在特定时间段上模拟策略的实现, 计算该策略的净值曲线.
### 结果展示
使用 `display.py` 模块展示回测结果. 回测结果的展示用到以下函数, 建立在 `value()` 所求得的净值曲线以及 `index_daily()` 所求得的指数基础上.
- `summary(value, index)` 根据净值曲线与基准指数计算策略的超额收益, 年化收益, 年化波动, 夏普比率以及 alpha, beta 值.
- `show_result(value, index)` 根据净值曲线与基准指数展示策略的回测结果, 包含 `summary()` 中报告的所有参数, 效果参考下图.
<img src='./1311506-20200520120344652-1328666592.png'>

## 数据流示意
<img src='./微信图片_20231116150943.jpg'>
